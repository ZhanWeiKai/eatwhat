<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…è’¸é²ˆé±¼å›¾ç‰‡æœç´¢æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1400px; margin: 0 auto; background: #f5f5f5; }
        h1 { color: #333; text-align: center; }
        .section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .keyword-display { font-size: 18px; color: #007bff; font-weight: bold; text-align: center; padding: 15px; background: #e7f3ff; border-radius: 4px; }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .image-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; transition: transform 0.2s; }
        .image-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .image-card img { width: 100%; height: 250px; object-fit: cover; display: block; }
        .image-info { padding: 10px; font-size: 12px; color: #666; word-break: break-all; }
        .image-number { font-weight: bold; color: #007bff; font-size: 14px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .button { padding: 12px 24px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; display: block; margin: 20px auto; }
        .button:hover { background: #0056b3; }
        .stats { text-align: center; padding: 15px; background: #d4edda; border-radius: 4px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>æ¸…è’¸é²ˆé±¼å›¾ç‰‡æœç´¢æµ‹è¯•</h1>

    <div class="section">
        <div class="keyword-display">
            æœç´¢å…³é”®è¯ï¼š<span id="keyword">æ¸…è’¸é²ˆé±¼èœè°±</span>
        </div>
        <div class="keyword-display" style="margin-top: 10px; background: #fff3cd;">
            ç™¾åº¦æœç´¢é“¾æ¥ï¼š<br>
            <a href="#" id="baiduLink" target="_blank" style="color: #856404; word-break: break-all;"></a>
        </div>
        <button class="button" onclick="startTest()">å¼€å§‹æµ‹è¯•ï¼šæå–å›¾ç‰‡URLå¹¶æ˜¾ç¤º</button>
    </div>

    <div id="stats" class="stats" style="display: none;"></div>

    <div class="section">
        <h2 style="text-align: center;">æå–åˆ°çš„å›¾ç‰‡</h2>
        <div id="loading" class="loading">ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹æœç´¢...</div>
        <div id="imageGrid" class="image-grid"></div>
    </div>

    <script>
        const API_BASE = 'http://api.jamesweb.org:8883/api';
        const KEYWORD = 'æ¸…è’¸é²ˆé±¼èœè°±';

        // è®¾ç½®ç™¾åº¦æœç´¢é“¾æ¥
        const encodedKeyword = encodeURIComponent(KEYWORD);
        const baiduSearchUrl = `https://image.baidu.com/search/index?tn=baiduimage&fm=result&ie=utf-8&word=${encodedKeyword}`;
        document.getElementById('baiduLink').href = baiduSearchUrl;
        document.getElementById('baiduLink').textContent = baiduSearchUrl;

        async function startTest() {
            const loading = document.getElementById('loading');
            const imageGrid = document.getElementById('imageGrid');
            const stats = document.getElementById('stats');

            loading.textContent = 'æ­£åœ¨æœç´¢å›¾ç‰‡ï¼Œè¯·ç¨å€™...';
            imageGrid.innerHTML = '';
            stats.style.display = 'none';

            try {
                // è°ƒç”¨å›¾ç‰‡æœç´¢API
                console.log('å¼€å§‹æœç´¢ï¼Œå…³é”®è¯:', KEYWORD);

                const response = await fetch(`${API_BASE}/image/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: KEYWORD })
                });

                const data = await response.json();
                console.log('APIå“åº”:', data);

                if (data.code === 200 && data.data && data.data.imageUrl) {
                    // æ˜¾ç¤ºé€‰ä¸­çš„å›¾ç‰‡
                    const selectedUrl = data.data.imageUrl;

                    // ç°åœ¨ç›´æ¥è¯·æ±‚ç™¾åº¦HTMLï¼Œæå–æ‰€æœ‰å›¾ç‰‡
                    loading.textContent = 'æ­£åœ¨ä»ç™¾åº¦æå–æ‰€æœ‰å›¾ç‰‡URL...';

                    const htmlResponse = await fetch(baiduSearchUrl, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                            'Accept-Language': 'zh-CN,zh;q=0.9',
                            'Referer': 'https://www.baidu.com/'
                        }
                    });

                    const html = await htmlResponse.text();
                    console.log('ç™¾åº¦HTMLé•¿åº¦:', html.length);

                    // æå–æ‰€æœ‰å›¾ç‰‡URL
                    const urls = extractImageUrls(html);
                    console.log('æå–åˆ°URLæ•°é‡:', urls.length);

                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    stats.style.display = 'block';
                    stats.innerHTML = `
                        <strong>æœç´¢ç»“æœç»Ÿè®¡ï¼š</strong><br>
                        æå–åˆ° ${urls.length} ä¸ªå›¾ç‰‡URL<br>
                        AIé€‰æ‹©çš„å›¾ç‰‡URLï¼š<span style="color: #dc3545;">åºå· ${urls.indexOf(selectedUrl) + 1}</span>
                    `;

                    // æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
                    loading.style.display = 'none';
                    displayImages(urls, selectedUrl);

                } else {
                    loading.textContent = 'æœç´¢å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯');
                    loading.style.color = 'red';
                }

            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                loading.textContent = 'æœç´¢å¤±è´¥ï¼š' + error.message;
                loading.style.color = 'red';
            }
        }

        function extractImageUrls(html) {
            const urls = [];
            const pattern = /https?:\/\/img[0-3]\.baidu\.com\/it\/u=[0-9]+,[0-9]+[^\">]*?\?[wh]=[0-9]+[^\">]*/gi;

            let match;
            const seen = new Set();
            while ((match = pattern.exec(html)) !== null && urls.length < 20) {
                let url = match[0];
                url = url.replace(/&amp;/g, '&');
                url = url.replace(/\\u0026/g, '&');

                if (!seen.has(url)) {
                    seen.add(url);
                    urls.push(url);
                }
            }

            return urls;
        }

        function displayImages(urls, selectedUrl) {
            const imageGrid = document.getElementById('imageGrid');

            urls.forEach((url, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';

                const isSelected = url === selectedUrl;

                if (isSelected) {
                    card.style.border = '3px solid #dc3545';
                    card.style.boxShadow = '0 0 20px rgba(220, 53, 69, 0.5)';
                }

                const img = document.createElement('img');
                img.src = url;
                img.alt = `å›¾ç‰‡ ${index + 1}`;

                img.onload = function() {
                    console.log(`å›¾ç‰‡ ${index + 1} åŠ è½½æˆåŠŸ`);
                };

                img.onerror = function() {
                    console.error(`å›¾ç‰‡ ${index + 1} åŠ è½½å¤±è´¥:`, url);
                    this.style.display = 'none';
                    card.innerHTML += '<div style="padding: 20px; color: red; text-align: center;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
                };

                const info = document.createElement('div');
                info.className = 'image-info';
                info.innerHTML = `
                    <div class="image-number">${isSelected ? 'ğŸ”´ AIé€‰æ‹©' : 'åºå· ' + (index + 1)}</div>
                    <div style="margin-top: 5px;">${url.substring(0, 80)}...</div>
                `;

                card.appendChild(img);
                card.appendChild(info);
                imageGrid.appendChild(card);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•');
            setTimeout(startTest, 1000);
        };
    </script>
</body>
</html>

# æ¨é€é€šçŸ¥åŠŸèƒ½æµ‹è¯•æŒ‡å—

## å·²ä¿®å¤çš„Bug

**é—®é¢˜**: WebSocketServiceæ— æ³•è·å–userIdï¼Œå¯¼è‡´WebSocketè¿æ¥ä»æœªå»ºç«‹
- åŸå› : SharedPreferencesæ–‡ä»¶åä¸ä¸€è‡´
  - RetrofitClient.java ä½¿ç”¨: `"What2Eat"`
  - WebSocketService.java ä½¿ç”¨: `"user"` âŒ (å·²ä¿®å¤)

**ä¿®å¤**: ç»Ÿä¸€ä½¿ç”¨ `"What2Eat"` ä½œä¸ºSharedPreferencesæ–‡ä»¶å

## æµ‹è¯•æ­¥éª¤

### å‡†å¤‡å·¥ä½œ

ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ:
```bash
cd springboot-backend
"C:\Program Files\JetBrains\IntelliJ IDEA 2025.2.5\plugins\maven\lib\maven3\bin\mvn.cmd" spring-boot:run
```

### æµ‹è¯•åœºæ™¯1: å•ç”¨æˆ·WebSocketè¿æ¥æµ‹è¯•

**ç›®çš„**: éªŒè¯WebSocketèƒ½å¤ŸæˆåŠŸè¿æ¥å¹¶è®¢é˜…ç”¨æˆ·é¢‘é“

**æ­¥éª¤**:

1. **æ¸…ç©ºlogcat** (å·²å®Œæˆ)
   ```bash
   adb logcat -c
   ```

2. **å¯åŠ¨æ—¥å¿—ç›‘æ§** (åœ¨æ–°çš„å‘½ä»¤è¡Œçª—å£æ‰§è¡Œ)
   ```bash
   adb -s 3BPUT24509015257 logcat | grep -E "WebSocket|STOMP|userId|LoginActivity|WebSocketService"
   ```

3. **åœ¨æ‰‹æœºä¸Šç™»å½•**
   - æ‰“å¼€"ä»Šå¤©åƒä»€ä¹ˆ"App
   - ä½¿ç”¨è´¦å·: testuser1 / 123456

4. **éªŒè¯æ—¥å¿—è¾“å‡º** - åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—(æŒ‰é¡ºåº):

   âœ… **æ­¥éª¤1**: LoginActivityæ£€æµ‹åˆ°å·²ç™»å½•ï¼Œå¯åŠ¨æœåŠ¡
   ```
   I LoginActivity   : Starting WebSocket service...
   I WebSocketService: WebSocketService creating...
   ```

   âœ… **æ­¥éª¤2**: è·å–userId
   ```
   I WebSocketService: WebSocket manager initialized for user: user001
   ```

   âœ… **æ­¥éª¤3**: WebSocketè¿æ¥æˆåŠŸ
   ```
   I WebSocketManager: Connecting to WebSocket...
   I WebSocketManager: WebSocket connected successfully
   I WebSocketManager: STOMP connection established
   ```

   âœ… **æ­¥éª¤4**: è®¢é˜…ç”¨æˆ·é¢‘é“
   ```
   D WebSocketManager: Sending SUBSCRIBE to: /topic/user/user001
   ```

**å¦‚æœçœ‹åˆ°ä»¥ä¸Šæ—¥å¿—ï¼Œè¯´æ˜WebSocketè¿æ¥æˆåŠŸ!** ğŸ‰

---

### æµ‹è¯•åœºæ™¯2: åŒç”¨æˆ·æ¨é€é€šçŸ¥æµ‹è¯•

**ç›®çš„**: éªŒè¯ç”¨æˆ·Aæ¨é€èœå•åï¼Œç”¨æˆ·Bèƒ½æ”¶åˆ°é€šçŸ¥

**å‰ææ¡ä»¶**:
- âœ… ç”¨æˆ·A(testuser1)å·²ç™»å½•ä¸”WebSocketè¿æ¥æˆåŠŸ
- âœ… ç”¨æˆ·B(testuser2)å·²ç™»å½•ä¸”WebSocketè¿æ¥æˆåŠŸ
- âœ… testuser1å’Œtestuser2å·²æ˜¯å¥½å‹å…³ç³»

**æ­¥éª¤**:

1. **åœ¨ç”¨æˆ·Açš„æ‰‹æœºä¸Š**:
   - è¿›å…¥"èœå•"é¡µé¢
   - é€‰æ‹©ä¸€äº›èœå“ï¼Œç‚¹å‡»"æ¨é€ç»™å¥½å‹"
   - é€‰æ‹©testuser2ï¼Œç¡®è®¤æ¨é€

2. **åœ¨ç”¨æˆ·Bçš„æ‰‹æœºä¸Š**:
   - åº”è¯¥ç«‹å³çœ‹åˆ°æ¨é€é€šçŸ¥å¼¹çª—
   - é€šçŸ¥å†…å®¹: "testuser1ç»™ä½ æ¨é€äº†èœå•"
   - ç‚¹å‡»é€šçŸ¥ â†’ æ‰“å¼€"æ¨é€åˆ—è¡¨"é¡µé¢
   - å¯ä»¥çœ‹åˆ°testuser1æ¨é€çš„èœå•è¯¦æƒ…

**é¢„æœŸæ•ˆæœ**:
- âœ… é€šçŸ¥æ å¼¹å‡ºé«˜ä¼˜å…ˆçº§é€šçŸ¥(å¸¦å£°éŸ³å’Œéœ‡åŠ¨)
- âœ… é€šçŸ¥å¯ä»¥ç‚¹å‡»è·³è½¬åˆ°PushListActivity
- âœ… ç‚¹å‡»åé€šçŸ¥è‡ªåŠ¨æ¶ˆå¤±
- âœ… åå°æœåŠ¡é€šçŸ¥ä»ç„¶åœ¨"æ­£åœ¨è¿è¡Œ"ä¸­æ˜¾ç¤º(ä½ä¼˜å…ˆçº§ï¼Œä¸æ˜¾ç¤ºåœ¨çŠ¶æ€æ )

---

### å¸¸è§é—®é¢˜æ’æŸ¥

#### Q1: æ²¡æœ‰çœ‹åˆ°ä»»ä½•WebSocketæ—¥å¿—

**æ£€æŸ¥userIdæ˜¯å¦ä¿å­˜**:
```bash
adb -s 3BPUT24509015257 shell "run-as com.what2eat cat /data/data/com.what2eat/shared_prefs/What2Eat.xml"
```

åº”è¯¥çœ‹åˆ°:
```xml
<?xml version='1.0' encoding='utf-8' standalone='yes' ?>
<map>
    <string name="token">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</string>
    <string name="userId">user001</string>
    <string name="username">testuser1</string>
    <string name="nickname">æµ‹è¯•ç”¨æˆ·1</string>
</map>
```

å¦‚æœçœ‹ä¸åˆ°userIdï¼Œè¯´æ˜ç™»å½•æ—¶æ²¡æœ‰æ­£ç¡®ä¿å­˜ç”¨æˆ·ä¿¡æ¯ã€‚

#### Q2: WebSocketè¿æ¥å¤±è´¥

**æ£€æŸ¥ç½‘ç»œè¿æ¥**:
```bash
# ç¡®è®¤èƒ½è®¿é—®åç«¯API
curl http://api.jamesweb.org:8883/api/health

# ç¡®è®¤WebSocketç«¯å£å¯è®¿é—®
curl -i -N \
  -H "Connection: Upgrade" \
  -H "Upgrade: websocket" \
  -H "Sec-WebSocket-Version: 13" \
  -H "Sec-WebSocket-Key: SGVsbG8sIHdvcmxkIQ==" \
  http://api.jamesweb.org:8883/api/ws
```

**æ£€æŸ¥åç«¯WebSocketæ—¥å¿—**:
- æŸ¥çœ‹Spring Bootæ§åˆ¶å°æ˜¯å¦æœ‰WebSocketè¿æ¥æ—¥å¿—
- åº”è¯¥çœ‹åˆ°: "WebSocketè¿æ¥å»ºç«‹: /topic/user/user001"

#### Q3: ç”¨æˆ·Aæ¨é€äº†ï¼Œä½†ç”¨æˆ·Bæ²¡æ”¶åˆ°é€šçŸ¥

**æ£€æŸ¥åç«¯æ¨é€æ—¥å¿—**:
```
æ¨é€æ¶ˆæ¯å·²å‘é€ç»™ 1/1 ä¸ªå¥½å‹
```

**æ£€æŸ¥ç”¨æˆ·Bçš„WebSocketæ—¥å¿—**:
```
I WebSocketManager: Received message: MESSAGE...
I WebSocketManager: Showing notification for push from: testuser1
I WebSocketManager: Notification displayed successfully
```

å¦‚æœæ²¡æœ‰"Received message"æ—¥å¿—ï¼Œè¯´æ˜:
- WebSocketæ¶ˆæ¯æ²¡æœ‰åˆ°è¾¾ç”¨æˆ·Bçš„è®¾å¤‡
- å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–WebSocketè¿æ¥å·²æ–­å¼€

---

## æˆåŠŸæ ‡å¿—

å½“æ‰€æœ‰æµ‹è¯•é€šè¿‡æ—¶ï¼Œä½ åº”è¯¥çœ‹åˆ°:

âœ… **åç«¯æ—¥å¿—**:
```
æ¨é€æ¶ˆæ¯å·²å‘é€ç»™ 1/1 ä¸ªå¥½å‹
```

âœ… **ç”¨æˆ·Bçš„Androidæ—¥å¿—**:
```
I WebSocketManager: Received message: MESSAGE
destination:/topic/user/user002

{"pushId":"...","pusherId":"user001","pusherName":"testuser1",...}
I WebSocketManager: Showing notification for push from: testuser1
I WebSocketManager: Notification displayed successfully
```

âœ… **ç”¨æˆ·Bçš„æ‰‹æœºå±å¹•**:
- å¼¹å‡ºé€šçŸ¥æ¨ªå¹…: "testuser1ç»™ä½ æ¨é€äº†èœå•"
- æœ‰å£°éŸ³å’Œéœ‡åŠ¨
- ç‚¹å‡»åæ‰“å¼€æ¨é€åˆ—è¡¨é¡µé¢

---

## ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡å:
1. æäº¤ä»£ç åˆ°Git
2. ç»§ç»­å®ç°åŠŸèƒ½2: èœå•åˆ†ç±»ç®¡ç†

# 关于通知栏显示的说明和解决方案

## 问题现状

您看到的通知栏显示：
- ❌ "今天吃什么 后台运行中，接收好友推送"
- 这个通知无法滑动删除
- 一直显示在通知栏

## 为什么会这样？

这是**Android系统的强制要求**，不是bug：

### Android前台服务的限制

从Android 8.0（API 26）开始，系统要求：
- ✅ 所有**前台服务**必须显示持续通知
- ✅ 这个通知**不能被滑动删除**（`setOngoing(true)`）
- ✅ 这是系统强制要求，应用无法绕过

### 为什么使用前台服务？

我们的推送功能需要使用**前台服务**来保持WebSocket连接，因为：

1. **后台服务会被杀死**
   - 普通后台服务在Android 8.0+很容易被系统杀死
   - 用户锁屏、切换应用时，后台服务可能被终止
   - WebSocket连接断开，无法接收推送

2. **前台服务不会被杀死**
   - 前台服务具有高优先级
   - 即使应用在后台，服务也能持续运行
   - WebSocket连接保持稳定，随时接收推送消息

### 已经做的优化

我已将通知设置为**最低优先级**（`IMPORTANCE_MIN`）：

```java
NotificationChannel channel = new NotificationChannel(
    "service_channel",
    "后台服务",
    NotificationManager.IMPORTANCE_MIN  // 最低重要性
);
channel.setShowBadge(false);  // 不显示角标
channel.enableVibration(false);  // 无震动
channel.enableLights(false);  // 无灯光
```

**效果**：
- ✅ 不会在状态栏显示图标
- ✅ 不会发出声音
- ✅ 不会震动
- ⚠️ 但在通知栏中仍然可见（系统强制要求）

## 不同品牌ROM的表现

| ROM类型 | 通知栏显示 | 说明 |
|---------|-----------|------|
| 原生Android | 只在"正在运行"中 | 最佳体验 |
| 华为EMUI | 在通知栏底部显示 | 您当前的情况 |
| 小米MIUI | 在通知栏显示 | 需手动隐藏 |
| OPPO ColorOS | 在通知栏显示 | 需手动隐藏 |

## 解决方案

### 方案1：手动隐藏（推荐）

华为手机：
1. 下拉通知栏
2. 长按"今天吃什么 后台运行中"通知
3. 选择"关闭此通知"或"隐藏"
4. 效果：服务继续运行，但通知不再显示

### 方案2：允许"后台弹出界面"

华为手机设置：
1. 设置 → 应用和服务 → 权限管理
2. 找到"今天吃什么"应用
3. 允许"后台弹出界面"
4. 效果：收到推送时即使应用在后台也能弹出界面

### 方案3：修改实现（不推荐）

**不使用前台服务**，改用普通后台服务：
- ❌ 应用在后台时容易被系统杀死
- ❌ WebSocket连接频繁断开
- ❌ 无法保证推送消息的实时性
- ❌ 用户体验更差

### 方案4：使用FCM（Firebase Cloud Messaging）

改用Google的官方推送服务：
- ✅ 无需前台服务
- ✅ 系统级推送，不会被杀死
- ❌ 需要Google Play服务（华为手机没有）
- ❌ 国内网络环境不稳定
- ❌ 实现复杂度高

## 当前实现的优点

虽然通知栏一直显示，但我们的实现有以下优点：

✅ **推送实时性高**：WebSocket连接稳定，消息即时送达
✅ **不依赖第三方**：纯WebSocket实现，无需Google服务
✅ **推送通知醒目**：收到消息时弹出高优先级通知横幅
✅ **服务持续运行**：即使用户锁屏也能接收推送

## 推送消息的实际效果

当好友推送菜单给您时：

1. **通知横幅弹出**（高优先级）
   ```
   qq给你推送了菜单
   总计：XX元，点击查看详情
   ```
   - 带声音和震动
   - 横幅从顶部弹出
   - 点击可查看详情

2. **点击通知后**
   - 自动打开"推送列表"页面
   - 显示好友推送的菜单详情
   - 可以查看菜品、价格等

3. **后台服务通知**
   - 保持在通知栏底部（或"正在运行"中）
   - 不影响使用
   - 保证WebSocket连接不断开

## 总结

- 通知栏显示"后台运行中"是**Android系统强制要求**，无法完全移除
- 这是为了保证推送功能的**稳定性和实时性**
- 您可以**手动隐藏**这个通知，不影响服务运行
- 收到推送时会**弹出醒目的通知横幅**，不会错过重要消息

## 测试步骤

1. 确认应用已打开并登录
2. 查看通知栏是否有"今天吃什么 后台运行中"
3. 让好友推送一个菜单给您
4. 观察是否弹出推送通知横幅
5. 点击通知查看是否跳转到推送列表

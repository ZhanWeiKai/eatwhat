<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æœç´¢æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        #chat-box {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 200px;
            margin-bottom: 10px;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
        }
        .message.user {
            background: #4CAF50;
            color: white;
            text-align: right;
        }
        .message.ai {
            background: #f0f0f0;
            color: #333;
        }
        #input-area {
            display: flex;
            gap: 10px;
        }
        #input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #send {
            padding: 10px 20px;
            background: #FF6600;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #log {
            background: #f5f5f5;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>å›¾ç‰‡æœç´¢åŠŸèƒ½æµ‹è¯•</h1>

    <div id="chat-box"></div>

    <div id="input-area">
        <input type="text" id="input" placeholder="è¾“å…¥èœå“åç§°ï¼Œå¦‚ï¼šçº¢çƒ§è‚‰" />
        <button id="send">å‘é€</button>
    </div>

    <h3>è°ƒè¯•æ—¥å¿—</h3>
    <div id="log"></div>

    <script>
        // é…ç½®
        const API_BASE_URL = 'http://api.jamesweb.org:8883/api';
        const TEST_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyMDAxIiwiaWF0IjoxNzM4NDU4NTAyLCJleHAiOjE3Mzg0NjkwMjJ9.abc'; // æµ‹è¯•ç”¨token

        let currentAIMessage = null;

        // é‡å†™console.logä»¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG: ' + args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN: ' + args.join(' '));
        };

        // å‘é€æ¶ˆæ¯
        document.getElementById('send').addEventListener('click', async () => {
            const input = document.getElementById('input');
            const message = input.value.trim();

            if (!message) return;

            addLog(`========== ç”¨æˆ·å‘é€æ¶ˆæ¯: ${message} ==========`);

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            input.value = '';

            // æ·»åŠ AIæ¶ˆæ¯å ä½ç¬¦
            currentAIMessage = addMessage('AIæ­£åœ¨å›å¤...', 'ai');

            try {
                // è°ƒç”¨AIèŠå¤©API
                addLog('å¼€å§‹è°ƒç”¨AIèŠå¤©API...');
                const response = await fetch(`${API_BASE_URL}/ai/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TEST_TOKEN}`
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                addLog(`AIèŠå¤©APIå“åº”: ${JSON.stringify(data)}`);

                if (data.code === 200 && data.data && data.data.message) {
                    const aiMessage = data.data.message;
                    addLog(`AIå›å¤å†…å®¹: ${aiMessage.substring(0, 50)}...`);

                    // æ˜¾ç¤ºAIå›å¤
                    currentAIMessage.innerHTML = aiMessage.replace(/\n/g, '<br>');

                    // å¼‚æ­¥æœç´¢å›¾ç‰‡
                    addLog('========== å‡†å¤‡è°ƒç”¨å›¾ç‰‡æœç´¢ ==========');
                    await searchDishImageAsync(message);
                } else {
                    currentAIMessage.innerHTML = 'æŠ±æ­‰ï¼ŒAIå›å¤å¤±è´¥';
                }
            } catch (error) {
                addLog(`é”™è¯¯: ${error.message}`);
                currentAIMessage.innerHTML = 'ç½‘ç»œé”™è¯¯';
            }
        });

        // å¼‚æ­¥æœç´¢å›¾ç‰‡
        async function searchDishImageAsync(userQuery) {
            addLog('===== searchDishImageAsync å‡½æ•°è¢«è°ƒç”¨');
            addLog(`===== æŸ¥è¯¢å†…å®¹: ${userQuery}`);
            addLog(`===== API_BASE_URL: ${API_BASE_URL}`);

            try {
                const url = `${API_BASE_URL}/image/search`;
                addLog(`===== è¯·æ±‚URL: ${url}`);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TEST_TOKEN}`
                    },
                    body: JSON.stringify({ query: userQuery })
                });

                addLog(`===== å“åº”çŠ¶æ€: ${response.status}`);

                const data = await response.json();
                addLog(`===== å›¾ç‰‡æœç´¢APIå“åº”: ${JSON.stringify(data)}`);

                if (data.code === 200 && data.data && data.data.imageUrl) {
                    const imageUrl = data.data.imageUrl;
                    addLog(`===== æˆåŠŸè·å–å›¾ç‰‡URL: ${imageUrl}`);

                    // æ·»åŠ å›¾ç‰‡åˆ°å½“å‰AIæ¶ˆæ¯
                    addImageToCurrentMessage(imageUrl);
                } else {
                    addLog('WARN: å›¾ç‰‡æœç´¢å¤±è´¥æˆ–æ— å›¾ç‰‡');
                }

            } catch (error) {
                addLog(`ERROR: å¼‚æ­¥å›¾ç‰‡æœç´¢å¤±è´¥: ${error.message}`);
            }
        }

        // æ·»åŠ å›¾ç‰‡åˆ°å½“å‰AIæ¶ˆæ¯
        function addImageToCurrentMessage(imageUrl) {
            if (!currentAIMessage) {
                addLog('WARN: å½“å‰AIæ¶ˆæ¯ä¸å­˜åœ¨');
                return;
            }

            addLog('æ­£åœ¨æ·»åŠ å›¾ç‰‡åˆ°æ¶ˆæ¯...');

            // ä½¿ç”¨createElementé¿å…HTMLå®ä½“è½¬ä¹‰é—®é¢˜
            const imageContainer = document.createElement('div');
            imageContainer.style.marginTop = '12px';

            const label = document.createElement('p');
            label.textContent = 'ğŸ“· èœå“å›¾ç‰‡ï¼š';
            label.style.color = '#FF6600';
            label.style.fontSize = '14px';
            imageContainer.appendChild(label);

            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'èœå“å›¾ç‰‡';
            img.style.maxWidth = '100%';
            img.style.borderRadius = '8px';
            img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';

            img.onload = function() {
                addLog('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ!');
            };

            img.onerror = function() {
                addLog('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥');
            };

            imageContainer.appendChild(img);
            currentAIMessage.appendChild(imageContainer);

            addLog('âœ… å›¾ç‰‡å·²æ·»åŠ åˆ°æ¶ˆæ¯');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(content, type) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = content;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return messageDiv;
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            addLog('========== é¡µé¢åŠ è½½å®Œæˆ ==========');
            addLog('å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æµ‹è¯•å›¾ç‰‡æœç´¢åŠŸèƒ½');
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试智谱AI联网搜索图片</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; background: #f5f5f5; }
        h1 { text-align: center; color: #333; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-group { margin: 15px 0; }
        input[type="text"] { padding: 10px; width: 300px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 14px; }
        .image-display { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .image-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .image-card img { width: 100%; height: 200px; object-fit: cover; display: block; }
        .image-url { padding: 10px; font-size: 11px; word-break: break-all; color: #666; }
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <h1>测试智谱AI联网搜索图片能力</h1>

    <div class="test-section">
        <h2>测试1：让智谱AI直接搜索菜品图片URL</h2>
        <div class="input-group">
            <input type="text" id="dishName" placeholder="输入菜名，如：清蒸鲈鱼" value="清蒸鲈鱼">
            <button onclick="testZhipuAI()">测试智谱AI联网搜索</button>
        </div>
        <div id="result1" class="result">等待测试...</div>
        <div id="images1" class="image-display"></div>
    </div>

    <div class="test-section">
        <h2>测试2：让智谱AI分步骤搜索</h2>
        <p style="color: #666;">先让AI生成搜索关键词，再让AI搜索图片</p>
        <div class="input-group">
            <input type="text" id="dishName2" placeholder="输入菜名" value="红烧肉">
            <button onclick="testZhipuAIStepByStep()">测试分步骤搜索</button>
        </div>
        <div id="result2" class="result">等待测试...</div>
        <div id="images2" class="image-display"></div>
    </div>

    <script>
        const API_BASE = 'http://api.jamesweb.org:8883/api';

        async function testZhipuAI() {
            const dishName = document.getElementById('dishName').value.trim();
            const resultDiv = document.getElementById('result1');
            const imagesDiv = document.getElementById('images1');

            if (!dishName) {
                alert('请输入菜名');
                return;
            }

            resultDiv.textContent = '正在调用智谱AI联网搜索...';
            imagesDiv.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `请搜索"${dishName}"的成品图片，并返回1-3个可以直接访问的图片URL。请使用联网搜索功能找到真实的图片链接。`
                    })
                });

                const data = await response.json();
                console.log('智谱AI响应:', data);

                resultDiv.textContent = JSON.stringify(data, null, 2);

                // 尝试从响应中提取图片URL
                const text = data.data?.message || '';
                const urls = extractUrls(text);

                if (urls.length > 0) {
                    displayImages(urls, imagesDiv);
                    resultDiv.textContent += '\n\n提取到 ' + urls.length + ' 个图片URL';
                } else {
                    resultDiv.textContent += '\n\n❌ 未提取到图片URL';
                }

            } catch (error) {
                resultDiv.textContent = '❌ 请求失败: ' + error.message;
                console.error('错误:', error);
            }
        }

        async function testZhipuAIStepByStep() {
            const dishName = document.getElementById('dishName2').value.trim();
            const resultDiv = document.getElementById('result2');
            const imagesDiv = document.getElementById('images2');

            if (!dishName) {
                alert('请输入菜名');
                return;
            }

            resultDiv.textContent = '步骤1：让AI生成搜索关键词...\n';
            imagesDiv.innerHTML = '';

            try {
                // 步骤1：生成搜索关键词
                const response1 = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `对于菜品"${dishName}"，请生成最适合的图片搜索关键词（2-4个字），不要任何解释，只要关键词。`
                    })
                });

                const data1 = await response1.json();
                const keywords = data1.data?.message?.trim() || dishName;
                resultDiv.textContent += `步骤1结果：${keywords}\n\n`;

                // 步骤2：使用关键词搜索图片
                resultDiv.textContent += `步骤2：使用关键词"${keywords}"搜索图片...\n`;

                const response2 = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `请使用联网搜索功能，搜索"${keywords}"的图片，返回1-3个可以直接在浏览器中访问的图片URL（必须是http或https开头）。`
                    })
                });

                const data2 = await response2.json();
                console.log('步骤2响应:', data2);

                resultDiv.textContent += `步骤2结果：\n\n${JSON.stringify(data2, null, 2)}`;

                // 提取并显示图片
                const text = data2.data?.message || '';
                const urls = extractUrls(text);

                if (urls.length > 0) {
                    displayImages(urls, imagesDiv);
                    resultDiv.textContent += '\n\n✅ 提取到 ' + urls.length + ' 个图片URL';
                } else {
                    resultDiv.textContent += '\n\n❌ 未提取到图片URL';
                }

            } catch (error) {
                resultDiv.textContent = '❌ 请求失败: ' + error.message;
                console.error('错误:', error);
            }
        }

        function extractUrls(text) {
            // 提取http/https开头的URL
            const urlPattern = /https?:\/\/[^\s\]\)]+/gi;
            const urls = text.match(urlPattern) || [];

            // 过滤：只保留图片URL
            const imageUrls = urls.filter(url => {
                const lower = url.toLowerCase();
                return lower.includes('http') &&
                       !lower.includes('baidu.com') &&  // 排除百度
                       !lower.includes('google.com') &&  // 排除Google
                       !lower.includes('.html') &&      // 排除HTML页面
                       !lower.includes('.htm') &&
                       (lower.includes('.jpg') ||
                        lower.includes('.jpeg') ||
                        lower.includes('.png') ||
                        lower.includes('.webp') ||
                        lower.includes('image') ||
                        lower.includes('img') ||
                        lower.includes('photo') ||
                        url.includes('itu'));
            });

            return [...new Set(imageUrls)];  // 去重
        }

        function displayImages(urls, container) {
            container.innerHTML = '';

            urls.forEach((url, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';

                const img = document.createElement('img');
                img.src = url;
                img.alt = `图片 ${index + 1}`;

                img.onerror = function() {
                    this.style.display = 'none';
                    card.innerHTML = '<div style="padding: 20px; color: red; text-align: center;">图片加载失败</div>';
                };

                const urlDiv = document.createElement('div');
                urlDiv.className = 'image-url';
                urlDiv.textContent = `${index + 1}. ${url}`;

                card.appendChild(img);
                card.appendChild(urlDiv);
                container.appendChild(card);
            });
        }

        // 页面加载后自动测试一次
        window.onload = function() {
            console.log('页面加载完成');
        };
    </script>
</body>
</html>
